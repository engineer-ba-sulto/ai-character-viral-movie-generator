# 調査: Better Auth と Cloudflare D1 による認証

## 1. 技術選定

### 決定

- **認証ライブラリ**: Better Auth
- **データベース**: Cloudflare D1

### 根拠

- **Better Auth**: 機能仕様書で指定されています。メール/パスワード認証、ソーシャルログイン、セッション管理など、必要な機能を提供します。Next.js との統合もサポートされています。
- **Cloudflare D1**: 機能仕様書で指定されています。サーバーレス環境に適しており、Next.js バックエンドとの相性が良いです。

### 検討された代替案

- **NextAuth.js**: 人気のある Next.js 認証ライブラリですが、今回は Better Auth が指定されています。
- **Supabase Auth**: 別の統合認証ソリューションですが、今回は Cloudflare D1 を直接使用することが要件です。

## 2. セッション管理戦略

### 課題

機能仕様書の「確認事項」セクションで、セッション管理に関する以下の点が未解決でした。

- セッション持続時間はどのくらいか？
- どのようなイベントがセッションを無効化するか？
- ユーザーは複数の同時セッションを持つことができるか？

### 調査と推奨事項

- **セッション持続時間**:

  - **調査**: 一般的な Web アプリケーションでは、セキュリティと利便性のバランスを取ります。「セッションを記憶する」オプションが有効な場合は数週間から数ヶ月、無効な場合は数時間から 24 時間が一般的です。
  - **推奨**: **24 時間**。ユーザーは毎日再ログインする必要がありますが、多くのアプリケーションで標準的な期間です。セキュリティを考慮し、まずは短めに設定します。

- **セッションの無効化**:

  - **調査**: セキュリティ上重要なイベントが発生した際には、セッションを強制的に無効化することがベストプラクティスです。
  - **推奨**: 以下のイベントでセッションを無効化します。
    - **ユーザーによるログアウト**: 明示的なアクション。
    - **パスワードの変更**: アカウント乗っ取りのリスクを軽減するため、他のすべてのデバイスからログアウトさせます。

- **同時セッション**:
  - **調査**: 多くのサービス（例: Google, Slack）は、利便性のために複数のデバイスからの同時ログインを許可しています。
  - **推奨**: **許可する**。ユーザーはデスクトップとモバイルデバイスで同時にログインできます。セキュリティダッシュボードなどでアクティブなセッションを確認できる機能を将来的に追加することも考えられます。

## 3. Better Auth と Next.js の統合パターン

### 調査

Better Auth の公式ドキュメントとコミュニティの事例を調査し、Next.js App Router での最適な統合方法を確認します。

- `[...better-auth]` ルートハンドラのセットアップ方法。
- サーバーコンポーネントとクライアントコンポーネントでのセッション情報の取得方法 (`auth()` ヘルパーなど)。
- Server Actions 内での認証状態の確認方法。
- `middleware.ts` を使用した特定ルートの保護方法。

### 推奨プラクティス

- 環境変数 (`AUTH_SECRET`, `AUTH_BETTER_AUTH_ID`, `AUTH_BETTER_AUTH_SECRET` など) を `.env.local` に設定します。
- `src/utils/auth/server.ts` (仮) に Better Auth の基本設定（プロバイダー、アダプター）を記述します。
- `D1Adapter` を使用して、セッション情報を Cloudflare D1 に永続化します。
- `middleware.ts` を作成し、ダッシュボードなどの認証が必要なページへのアクセスを制御します。

## 4. Cloudflare D1 のスキーマ設計

### 調査

Better Auth の `D1Adapter` が要求するテーブルスキーマを調査します。通常、以下のテーブルが必要です。

- `users`: ユーザーの基本情報（`id`, `name`, `email`, `image`など）。
- `accounts`: 複数の認証プロバイダー（例: email, google）を 1 人のユーザーにリンクさせます。
- `sessions`: ユーザーのログインセッション情報を保存します。
- `verification_tokens`: メールアドレス確認などの一時的なトークンを保存します。

### 推奨スキーマ

Better Auth の公式ドキュメントで推奨されている D1 スキーマ定義に従います。Drizzle ORM を使用してマイグレーションファイルを生成し、スキーマを管理します。
