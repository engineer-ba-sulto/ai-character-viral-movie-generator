# 実装計画: [機能名]

**ブランチ**: `[###-feature-name]` | **日付**: [日付] | **仕様書**: [リンク]
**入力**: `/specs/[###-feature-name]/spec.md` からの機能仕様書

## 実行フロー (/plan コマンドのスコープ)

```
1. 入力パスから機能仕様書を読み込む
   → 見つからない場合: ERROR "No feature spec at {path}"
2. 技術的背景を記入する (要明確化項目をスキャン)
   → ファイルシステム構造またはコンテキストからプロジェクトタイプを検出 (web=frontend+backend, mobile=app+api)
   → プロジェクトタイプに基づいて構造決定を設定
3. 憲章ドキュメントの内容に基づいて憲章チェックセクションを記入する
4. 下記の憲章チェックセクションを評価する
   → 違反がある場合: 複雑性追跡に記録
   → 正当化できない場合: ERROR "Simplify approach first"
   → 進捗追跡を更新: 初期憲章チェック
5. フェーズ0を実行 → research.md
   → 要明確化項目が残っている場合: ERROR "Resolve unknowns"
6. フェーズ1を実行 → contracts, data-model.md, quickstart.md, エージェント固有のテンプレートファイル (例: Claude Code用の `CLAUDE.md`, GitHub Copilot用の `.github/copilot-instructions.md`, Gemini CLI用の `GEMINI.md`, Qwen Code用の `QWEN.md`, またはその他のエージェント用の `AGENTS.md`)
7. 憲章チェックセクションを再評価する
   → 新しい違反がある場合: 設計をリファクタリングし、フェーズ1に戻る
   → 進捗追跡を更新: 設計後憲章チェック
8. フェーズ2を計画 → タスク生成アプローチを記述する (tasks.mdは作成しない)
9. 停止 - /tasks コマンドの準備完了
```

**重要**: /plan コマンドはステップ 7 で停止します。フェーズ 2-4 は他のコマンドによって実行されます:

- フェーズ 2: /tasks コマンドが tasks.md を作成
- フェーズ 3-4: 実装の実行 (手動またはツール経由)

## 概要

Cloudflare D1 をデータベースとして利用し、メール/パスワードベースのログインをサポートする形で、ユーザー認証のために Better Auth を統合します。Better Auth の標準的な API パターンを使用して、セキュアなサインアップ・ログイン機能を実装します。調査フェーズでは、最適なセッション管理戦略（期間、無効化トリガー、同時セッションの可否）を決定します。

## 技術的背景

**言語/バージョン**: TypeScript
**主要な依存関係**: Next.js, Better Auth, React Hook Form, Zod
**ストレージ**: Cloudflare D1
**テスト**: Vitest (想定)
**対象プラットフォーム**: Web
**プロジェクトタイプ**: Web アプリケーション (Next.js)
**パフォーマンス目標**: 認証リクエストは p99 で 500ms 未満
**制約**: Better Auth と Cloudflare D1 の制約に従う
**スケール/スコープ**: MVP として基本的なメール/パスワード認証に限定
**実装アプローチ**: Better Auth の`auth.api.signUpEmail()`と`auth.api.signInEmail()`を使用したサーバーアクション実装

## 憲章チェック

_ゲート: フェーズ 0 の調査の前に合格する必要があります。フェーズ 1 の設計の後に再チェックします。_

- [x] **技術スタック**: 計画は承認された技術スタックを使用していますか？ (Next.js, Better Auth, D1)
- [x] **ファイル/関数サイズ**: 設計は大きすぎるファイルや関数を予測し、回避していますか？ (各ファイルを単一責任に保つ)
- [x] **OOP / モジュール性**: 設計はオブジェクト指向でモジュール化されていますか？ (認証ロジックをサービスとして分離)
- [x] **単一責任**: コンポーネントは単一の明確な責任を持っていますか？ (UI コンポーネント、フォーム、API ルートを分離)
- [x] **関心の分離**: UI、ビジネスロジック、状態の間に明確な分離がありますか？ (hooks, utils, providers を活用)
- [x] **命名と構造**: 提案されたファイル構造と命名は規約に従っていますか？ (憲章の規約通り)
- [x] **サーバーアクション**: サーバーアクションはミューテーションのみに正しく使用されていますか？ (フォーム送信に Server Actions を使用)

## プロジェクト構造

### ドキュメンテーション (この機能)

```
specs/[###-feature]/
├── plan.md              # このファイル (/plan コマンドの出力)
├── research.md          # フェーズ0の出力 (/plan コマンド)
├── data-model.md        # フェーズ1の出力 (/plan コマンド)
├── quickstart.md        # フェーズ1の出力 (/plan コマンド)
├── contracts/           # フェーズ1の出力 (/plan コマンド)
└── tasks.md             # フェーズ2の出力 (/tasks コマンド - /plan では作成されない)
```

### ソースコード (リポジトリルート)

```
src/
├── app/
│   ├── (auth)/
│   │   ├── login/
│   │   │   └── page.tsx      # ログインページUI (T014)
│   │   ├── signup/
│   │   │   └── page.tsx      # サインアップページUI (T013)
│   │   └── layout.tsx        # 認証ページの共通レイアウト (T012)
│   └── api/
│       └── auth/
│           ├── [..better-auth]/ # Better Authのコールバックなど
│           │   └── route.ts
│           └── ...
├── actions/
│   └── auth.actions.ts     # Better Authを使用したログイン/サインアップのServer Actions
├── components/
│   ├── login-form.tsx      # shadcn/ui login-01ブロックから生成 (T011)
│   └── signup-form.tsx     # shadcn/ui signup-01ブロックから生成 (T011)
├── types/
│   └── auth.ts             # Zodスキーマと認証関連の型定義
└── utils/
    └── auth/
        ├── server.ts       # Better Authサーバーサイド設定
        └── client.ts       # Better Authクライアントサイド設定
```

**構造決定**: 憲章で定義された Web アプリケーション (Next.js) の構造に従います。認証関連のロジックは`src/app/(auth)`、`src/actions`、`src/utils/auth`などに分離して配置します。Better Auth の標準的な API パターンを使用し、サーバーアクションで`auth.api.signUpEmail()`と`auth.api.signInEmail()`を呼び出します。

**UI 実装アプローチ**: shadcn/ui のブロック（`signup-01`、`login-01`）をコマンドで導入し、生成されたフォームコンポーネントを`(auth)`ルートグループのレイアウトと組み合わせて使用します。これにより、一貫したデザインシステムと効率的な開発を実現します。

## フェーズ 0: 概要と調査

1. 上記の**技術的背景から不明点を抽出**する:

   - 各「要明確化」項目 → 調査タスク
   - 各依存関係 → ベストプラクティスタスク
   - 各統合 → パターンタスク

2. **調査エージェントを生成して実行**する:

   ```
   技術的背景の各不明点について:
     タスク: "{feature context}のための{unknown}の調査"
   各技術選択について:
     タスク: "{domain}における{tech}のベストプラクティスの検索"
   ```

3. `research.md`に**調査結果を統合**するフォーマット:
   - 決定: [選択されたもの]
   - 根拠: [なぜ選択されたか]
   - 検討された代替案: [他に評価されたもの]

**出力**: 全ての「要明確化」項目が解決された `research.md`

## フェーズ 1: 設計と契約

_前提条件: research.md が完了していること_

1. **機能仕様書からエンティティを抽出** → `data-model.md`:

   - エンティティ名, フィールド, 関係
   - 要件からの検証ルール
   - 該当する場合の状態遷移

2. **機能要件から API 契約を生成**する:

   - 各ユーザーアクション → エンドポイント
   - Better Auth の標準的な API パターンを使用（`auth.api.signUpEmail()`, `auth.api.signInEmail()`）
   - OpenAPI/GraphQL スキーマを `/contracts/` に出力

3. **ユーザーストーリーからクイックスタート手順を抽出**する:

   - 各ストーリー → クイックスタートの検証ステップ

4. **エージェントファイルをインクリメンタルに更新**する (O(1) 操作):
   - `.specify/scripts/bash/update-agent-context.sh cursor` を実行する
     **重要**: 上記の通りに正確に実行してください。引数を追加したり削除したりしないでください。
   - 存在する場合: 現在の計画から新しい技術のみを追加
   - マーカー間の手動追加を維持
   - 最近の変更を更新 (最後の 3 つを保持)
   - トークン効率のために 150 行未満に維持
   - リポジトリルートに出力

**出力**: data-model.md, /contracts/\*, quickstart.md, エージェント固有ファイル

## フェーズ 2: タスク計画アプローチ

_このセクションは /tasks コマンドが何をするかを記述するものであり、/plan 中には実行されません_

**タスク生成戦略**:

- `.specify/templates/tasks-template.md` をベースとして読み込む
- フェーズ 1 の設計ドキュメント (契約, データモデル, クイックスタート) からタスクを生成する
- 各エンティティ → モデル作成タスク [P]
- Better Auth のサーバーアクション実装タスク（T009, T010）
- shadcn/ui ブロック導入タスク（T011）
- 認証レイアウト作成タスク（T012）
- 認証ページ作成タスク（T013, T014）
- ミドルウェア実装タスク（T015）
- ドキュメント作成タスク（T016）

**順序付け戦略**:

- 依存関係順: モデル → Better Auth 設定 → サーバーアクション → shadcn/ui ブロック導入 → レイアウト → ページ → ミドルウェア → ドキュメント
- 並列実行可能なものに [P] をマーク (独立したファイル)

**推定出力**: tasks.md に 16 個の番号付き、順序付けされたタスク

**重要**: このフェーズは /tasks コマンドによって実行され、/plan では実行されません

## 実装詳細

### Better Auth サーバーアクション実装

**T009: サインアップ用サーバーアクション**

- `auth.api.signUpEmail()`を使用
- Zod スキーマによるバリデーション
- パスワード強度チェック（大文字、小文字、数字を含む）
- エラーハンドリングとフィールドレベルのエラー表示

**T010: ログイン用サーバーアクション**

- `auth.api.signInEmail()`を使用
- `rememberMe`機能のサポート
- Better Auth のエラーメッセージの日本語化
- セッション管理の自動化

### UI 実装とレイアウト

**T011: shadcn/ui ブロック導入**

- `npx shadcn add signup-01` - サインアップフォームコンポーネント生成
- `npx shadcn add login-01` - ログインフォームコンポーネント生成
- 生成されたコンポーネントを react-hook-form とサーバーアクションと統合

**T012: 認証レイアウト作成**

- `src/app/(auth)/layout.tsx` - 認証ページの共通レイアウト
- カードデザインと中央配置の提供

**T013/T014: 認証ページ作成**

- `src/app/(auth)/signup/page.tsx` - サインアップページ
- `src/app/(auth)/login/page.tsx` - ログインページ
- T012 のレイアウトと T011 のフォームコンポーネントを組み合わせ

### 型定義とバリデーション

- `signupSchema`: 名前、メール、パスワード、パスワード確認のバリデーション
- `loginSchema`: メール、パスワード、rememberMe のバリデーション
- フィールドレベルのエラー表示対応

### セキュリティ機能

- Better Auth による自動パスワードハッシュ化（scrypt）
- セッションクッキーの自動管理
- CSRF 保護の自動実装
- セキュアなログアウト処理

## フェーズ 3+: 将来の実装

_これらのフェーズは /plan コマンドのスコープ外です_

**フェーズ 3**: タスク実行 (/tasks コマンドが tasks.md を作成)
**フェーズ 4**: 実装 (憲章の原則に従って tasks.md を実行)
**フェーズ 5**: 検証 (quickstart.md の実行, パフォーマンス検証)

## 複雑性追跡

_憲章チェックに正当化が必要な違反がある場合にのみ記入_

| 違反                       | なぜ必要か     | より単純な代替案が棄却された理由      |
| -------------------------- | -------------- | ------------------------------------- |
| [例: 4 番目のプロジェクト] | [現在の必要性] | [なぜ 3 つのプロジェクトでは不十分か] |
| [例: リポジトリパターン]   | [特定の問題]   | [なぜ直接 DB アクセスでは不十分か]    |

## 進捗追跡

_このチェックリストは実行フロー中に更新されます_

**フェーズステータス**:

- [x] フェーズ 0: 調査完了 (/plan コマンド)
- [x] フェーズ 1: 設計完了 (/plan コマンド)
- [x] フェーズ 2: タスク計画完了 (/plan コマンド - アプローチのみ記述)
- [ ] フェーズ 3: タスク生成完了 (/tasks コマンド)
- [ ] フェーズ 4: 実装完了
- [ ] フェーズ 5: 検証合格

**ゲートステータス**:

- [x] 初期憲章チェック: 合格
- [x] 設計後憲章チェック: 合格
- [x] 全ての「要明確化」項目が解決済み
- [ ] 複雑性の逸脱が文書化済み

---

_憲章 v1.0.0 に基づく - `/memory/constitution.md` を参照_
